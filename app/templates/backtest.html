<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›æµ‹å·¥å…· - ETF/è‚¡ç¥¨å›æµ‹ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .instrument-list {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 1rem;
        }

        .instrument-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f7fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .instrument-info {
            flex: 1;
        }

        .instrument-symbol {
            font-weight: 600;
            color: #667eea;
        }

        .instrument-name {
            font-size: 0.9rem;
            color: #718096;
        }

        .weight-input {
            width: 80px;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            text-align: center;
        }

        .remove-btn {
            background: #fed7d7;
            color: #c53030;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-block {
            width: 100%;
            margin: 1rem 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .alert-error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        .alert-success {
            background: #c6f6d5;
            color: #276749;
            border: 1px solid #9ae6b4;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-button {
            padding: 1rem 2rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #718096;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .transaction-table th,
        .transaction-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .transaction-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ æŠ•èµ„ç»„åˆå›æµ‹å·¥å…·</h1>
            <p>è¾“å…¥æŠ•èµ„ç­–ç•¥å‚æ•°ï¼Œç«‹å³è¿›è¡Œå†å²æ•°æ®å›æµ‹åˆ†æ</p>
            <a href="/" class="btn btn-secondary" style="margin-top: 1rem;">â† è¿”å›é¦–é¡µ</a>
        </div>

        <!-- å›æµ‹è¡¨å• -->
        <div class="card">
            <h2>ğŸ”§ å›æµ‹é…ç½®</h2>
            <form id="backtestForm">
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label for="portfolioName">æŠ•èµ„ç»„åˆåç§°</label>
                            <input type="text" id="portfolioName" class="form-control" value="æˆ‘çš„å›æµ‹ç»„åˆ" required>
                        </div>

                        <div class="form-group">
                            <label for="initialCapital">åˆå§‹èµ„é‡‘ (ç¾å…ƒ)</label>
                            <input type="number" id="initialCapital" class="form-control" value="10000" min="1000" required>
                        </div>

                        <div class="form-group">
                            <label for="frequency">æŠ•èµ„é¢‘ç‡</label>
                            <select id="frequency" class="form-control" required>
                                <option value="MONTHLY">æ¯æœˆå®šæŠ•</option>
                                <option value="WEEKLY">æ¯å‘¨å®šæŠ•</option>
                                <option value="DAILY">æ¯æ—¥å®šæŠ•</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="buyAmount">å•æ¬¡æŠ•èµ„é‡‘é¢ (ç¾å…ƒ)</label>
                            <input type="number" id="buyAmount" class="form-control" value="1000" min="100" required>
                        </div>
                    </div>

                    <div>
                        <div class="form-group">
                            <label for="startDate">å›æµ‹å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="startDate" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="endDate">å›æµ‹ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="endDate" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="transactionFee">æ‰‹ç»­è´¹ç‡ (%)</label>
                            <input type="number" id="transactionFee" class="form-control" value="0.03" min="0" max="1" step="0.01" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>æŠ•èµ„æ ‡çš„</label>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <input type="text" id="symbolInput" class="form-control" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: SPY, QQQ, AAPL)" style="flex: 1;">
                        <button type="button" id="addSymbolBtn" class="btn btn-secondary">æ·»åŠ æ ‡çš„</button>
                    </div>
                    <div id="instrumentList" class="instrument-list">
                        <p style="text-align: center; color: #718096;">è¯·æ·»åŠ æŠ•èµ„æ ‡çš„</p>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">ğŸš€ å¼€å§‹å›æµ‹</button>
            </form>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading" class="card loading">
            <div class="spinner"></div>
            <h3>æ­£åœ¨æ‰§è¡Œå›æµ‹...</h3>
            <p>è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
        </div>

        <!-- é”™è¯¯ä¿¡æ¯ -->
        <div id="errorMessage" class="alert alert-error" style="display: none;"></div>

        <!-- å›æµ‹ç»“æœ -->
        <div id="results" class="results">
            <!-- ç»©æ•ˆæŒ‡æ ‡ -->
            <div class="card">
                <h2>ğŸ“Š å›æµ‹ç»“æœ</h2>
                <div id="metricsGrid" class="metrics-grid">
                    <!-- åŠ¨æ€ç”ŸæˆæŒ‡æ ‡å¡ç‰‡ -->
                </div>
            </div>

            <!-- å›¾è¡¨å’Œè¯¦ç»†æ•°æ® -->
            <div class="card">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="chart">ğŸ“ˆ æ”¶ç›Šæ›²çº¿</button>
                    <button class="tab-button" data-tab="transactions">ğŸ’° äº¤æ˜“è®°å½•</button>
                    <button class="tab-button" data-tab="holdings">ğŸ“‹ æŒä»“è¯¦æƒ…</button>
                </div>

                <div id="chartTab" class="tab-content active">
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <div id="transactionsTab" class="tab-content">
                    <h3>äº¤æ˜“è®°å½•</h3>
                    <div id="transactionsTable"></div>
                </div>

                <div id="holdingsTab" class="tab-content">
                    <h3>æœ€ç»ˆæŒä»“</h3>
                    <div id="holdingsTable"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let token = null;
        let chart = null;
        let instruments = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            setupEventListeners();
            login();
        });

        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        function initializeDates() {
            const today = new Date();
            const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());

            document.getElementById('startDate').value = oneYearAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            document.getElementById('backtestForm').addEventListener('submit', handleBacktest);
            document.getElementById('addSymbolBtn').addEventListener('click', addSymbol);
            document.getElementById('symbolInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addSymbol();
                }
            });

            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
        }

        // è‡ªåŠ¨ç™»å½•
        async function login() {
            try {
                const response = await axios.post('/api/auth/login', {
                    username: 'demo',
                    password: 'password123'
                });

                token = response.data.access_token;
                axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

                // æ·»åŠ é»˜è®¤æ ‡çš„
                addDefaultInstruments();
            } catch (error) {
                showError('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€');
            }
        }

        // æ·»åŠ é»˜è®¤æŠ•èµ„æ ‡çš„
        function addDefaultInstruments() {
            const defaultSymbols = ['SPY', 'QQQ'];
            defaultSymbols.forEach(symbol => {
                addSymbolToList(symbol);
            });
        }

        // æ·»åŠ æŠ•èµ„æ ‡çš„
        async function addSymbol() {
            const symbolInput = document.getElementById('symbolInput');
            const symbol = symbolInput.value.trim().toUpperCase();

            if (!symbol) return;

            try {
                // æœç´¢æ ‡çš„ä¿¡æ¯
                const response = await axios.get(`/api/instruments/search?symbol=${symbol}`);
                addSymbolToList(symbol, response.data);
                symbolInput.value = '';
            } catch (error) {
                showError(`æ ‡çš„ ${symbol} ä¸å­˜åœ¨æˆ–è·å–ä¿¡æ¯å¤±è´¥`);
            }
        }

        // æ·»åŠ æ ‡çš„åˆ°åˆ—è¡¨
        function addSymbolToList(symbol, instrumentData = null) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (instruments.find(item => item.symbol === symbol)) {
                showError(`æ ‡çš„ ${symbol} å·²å­˜åœ¨`);
                return;
            }

            const instrument = {
                symbol: symbol,
                name: instrumentData ? instrumentData.name : symbol,
                weight: (100 / (instruments.length + 1)).toFixed(1)
            };

            instruments.push(instrument);
            updateInstrumentList();
        }

        // æ›´æ–°æŠ•èµ„æ ‡çš„åˆ—è¡¨æ˜¾ç¤º
        function updateInstrumentList() {
            const container = document.getElementById('instrumentList');

            if (instruments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">è¯·æ·»åŠ æŠ•èµ„æ ‡çš„</p>';
                return;
            }

            // é‡æ–°è®¡ç®—æƒé‡
            const equalWeight = (100 / instruments.length).toFixed(1);
            instruments.forEach(item => item.weight = equalWeight);

            container.innerHTML = instruments.map((item, index) => `
                <div class="instrument-item">
                    <div class="instrument-info">
                        <div class="instrument-symbol">${item.symbol}</div>
                        <div class="instrument-name">${item.name}</div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="number" class="weight-input" value="${item.weight}"
                               min="0" max="100" step="0.1"
                               onchange="updateWeight(${index}, this.value)">
                        <span style="margin-left: 0.5rem;">%</span>
                        <button type="button" class="remove-btn" onclick="removeInstrument(${index})">ç§»é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // æ›´æ–°æƒé‡
        function updateWeight(index, weight) {
            instruments[index].weight = parseFloat(weight);
        }

        // ç§»é™¤æŠ•èµ„æ ‡çš„
        function removeInstrument(index) {
            instruments.splice(index, 1);
            updateInstrumentList();
        }

        // æ‰§è¡Œå›æµ‹
        async function handleBacktest(e) {
            e.preventDefault();

            if (instruments.length === 0) {
                showError('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæŠ•èµ„æ ‡çš„');
                return;
            }

            // éªŒè¯æƒé‡æ€»å’Œ
            const totalWeight = instruments.reduce((sum, item) => sum + parseFloat(item.weight), 0);
            if (Math.abs(totalWeight - 100) > 0.1) {
                showError(`æƒé‡æ€»å’Œåº”ä¸º100%ï¼Œå½“å‰ä¸º${totalWeight.toFixed(1)}%`);
                return;
            }

            showLoading();
            hideError();

            try {
                // åˆ›å»ºæŠ•èµ„ç»„åˆ
                const portfolioData = {
                    name: document.getElementById('portfolioName').value,
                    description: 'é€šè¿‡å‰ç«¯å·¥å…·åˆ›å»ºçš„å›æµ‹ç»„åˆ',
                    initial_capital: parseFloat(document.getElementById('initialCapital').value),
                    currency: 'USD'
                };

                const portfolioResponse = await axios.post('/api/portfolios', portfolioData);
                const portfolioId = portfolioResponse.data.id;

                // æ·»åŠ æŠ•èµ„é…ç½®
                for (const instrument of instruments) {
                    // å…ˆæœç´¢æˆ–åˆ›å»ºæ ‡çš„
                    await axios.get(`/api/instruments/search?symbol=${instrument.symbol}`);

                    // è·å–æ ‡çš„ID
                    const instrumentResponse = await axios.get(`/api/instruments/search?symbol=${instrument.symbol}`);

                    const configData = {
                        instrument_id: instrumentResponse.data.id,
                        weight: parseFloat(instrument.weight) / 100,
                        investment_frequency: document.getElementById('frequency').value,
                        frequency_detail: getFrequencyDetail(),
                        transaction_fee_rate: parseFloat(document.getElementById('transactionFee').value) / 100,
                        buy_type: 'AMOUNT',
                        buy_amount: parseFloat(document.getElementById('buyAmount').value) * (parseFloat(instrument.weight) / 100),
                        start_date: document.getElementById('startDate').value
                    };

                    await axios.post(`/api/portfolios/${portfolioId}/configurations`, configData);
                }

                // æ‰§è¡Œå›æµ‹
                const backtestData = {
                    portfolio_id: portfolioId,
                    name: `${portfolioData.name} - å›æµ‹ç»“æœ`,
                    start_date: document.getElementById('startDate').value,
                    end_date: document.getElementById('endDate').value
                };

                const backtestResponse = await axios.post('/api/backtests', backtestData);

                // æ˜¾ç¤ºç»“æœ
                await displayResults(backtestResponse.data);

            } catch (error) {
                console.error('å›æµ‹å¤±è´¥:', error);
                showError(error.response?.data?.message || 'å›æµ‹æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥å‚æ•°');
            } finally {
                hideLoading();
            }
        }

        // è·å–é¢‘ç‡è¯¦ç»†é…ç½®
        function getFrequencyDetail() {
            const frequency = document.getElementById('frequency').value;
            switch (frequency) {
                case 'MONTHLY':
                    return { day: 1 };
                case 'WEEKLY':
                    return { weekday: 1 }; // Monday
                case 'DAILY':
                    return {};
                default:
                    return {};
            }
        }

        // æ˜¾ç¤ºå›æµ‹ç»“æœ
        async function displayResults(backtestResult) {
            // æ˜¾ç¤ºåŸºæœ¬æŒ‡æ ‡
            displayMetrics(backtestResult);

            // è·å–è¯¦ç»†ç»©æ•ˆæ•°æ®
            const performanceResponse = await axios.get(`/api/backtests/${backtestResult.id}/performance`);
            const performanceData = performanceResponse.data;

            // ç»˜åˆ¶å›¾è¡¨
            drawPerformanceChart(performanceData.daily_values);

            // è·å–äº¤æ˜“è®°å½•
            const transactionsResponse = await axios.get(`/api/backtests/${backtestResult.id}/transactions`);
            displayTransactions(transactionsResponse.data);

            // è·å–æŒä»“è®°å½•
            const holdingsResponse = await axios.get(`/api/backtests/${backtestResult.id}/holdings`);
            displayHoldings(holdingsResponse.data);

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('results').classList.add('show');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // æ˜¾ç¤ºç»©æ•ˆæŒ‡æ ‡
        function displayMetrics(data) {
            const metrics = [
                { label: 'æ€»æ”¶ç›Šç‡', value: (data.total_return * 100).toFixed(2) + '%', color: data.total_return >= 0 ? '#48bb78' : '#f56565' },
                { label: 'å¹´åŒ–æ”¶ç›Šç‡', value: (data.annualized_return * 100).toFixed(2) + '%', color: data.annualized_return >= 0 ? '#48bb78' : '#f56565' },
                { label: 'æœ€å¤§å›æ’¤', value: data.max_drawdown ? (Math.abs(data.max_drawdown) * 100).toFixed(2) + '%' : 'N/A', color: '#ed8936' },
                { label: 'å¤æ™®æ¯”ç‡', value: data.sharpe_ratio ? data.sharpe_ratio.toFixed(2) : 'N/A', color: '#667eea' },
                { label: 'æ³¢åŠ¨ç‡', value: data.volatility ? (data.volatility * 100).toFixed(2) + '%' : 'N/A', color: '#9f7aea' },
                { label: 'äº¤æ˜“æ¬¡æ•°', value: data.total_trades.toString(), color: '#38b2ac' },
                { label: 'åˆå§‹èµ„é‡‘', value: '$' + data.initial_capital.toLocaleString(), color: '#4a5568' },
                { label: 'æœ€ç»ˆä»·å€¼', value: '$' + data.final_value.toLocaleString(), color: data.final_value >= data.initial_capital ? '#48bb78' : '#f56565' }
            ];

            const metricsHtml = metrics.map(metric => `
                <div class="metric-card" style="background: linear-gradient(135deg, ${metric.color} 0%, ${metric.color}99 100%);">
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                </div>
            `).join('');

            document.getElementById('metricsGrid').innerHTML = metricsHtml;
        }

        // ç»˜åˆ¶æ”¶ç›Šæ›²çº¿å›¾
        function drawPerformanceChart(dailyValues) {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            const dates = dailyValues.map(item => item.date);
            const portfolioValues = dailyValues.map(item => item.portfolio_value);
            const initialValue = portfolioValues[0];
            const benchmarkValues = portfolioValues.map((_, index) => initialValue * (1 + index * 0.0002)); // ç®€å•åŸºå‡†

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'æŠ•èµ„ç»„åˆä»·å€¼',
                            data: portfolioValues,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'åˆå§‹æŠ•èµ„',
                            data: Array(portfolioValues.length).fill(initialValue),
                            borderColor: '#cbd5e0',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æŠ•èµ„ç»„åˆæ”¶ç›Šæ›²çº¿'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æŠ•èµ„ç»„åˆä»·å€¼ ($)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // æ˜¾ç¤ºäº¤æ˜“è®°å½•
        function displayTransactions(transactions) {
            if (!transactions || transactions.length === 0) {
                document.getElementById('transactionsTable').innerHTML = '<p>æš‚æ— äº¤æ˜“è®°å½•</p>';
                return;
            }

            const tableHtml = `
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>æ ‡çš„</th>
                            <th>ç±»å‹</th>
                            <th>æ•°é‡</th>
                            <th>ä»·æ ¼</th>
                            <th>é‡‘é¢</th>
                            <th>æ‰‹ç»­è´¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.slice(0, 20).map(tx => `
                            <tr>
                                <td>${tx.transaction_date}</td>
                                <td>${tx.instrument?.symbol || 'N/A'}</td>
                                <td><span style="color: ${tx.transaction_type === 'BUY' ? '#48bb78' : '#f56565'}">${tx.transaction_type}</span></td>
                                <td>${parseFloat(tx.quantity).toFixed(3)}</td>
                                <td>$${parseFloat(tx.price).toFixed(2)}</td>
                                <td>$${parseFloat(tx.total_amount).toFixed(2)}</td>
                                <td>$${parseFloat(tx.fee).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${transactions.length > 20 ? `<p style="margin-top: 1rem; color: #718096;">æ˜¾ç¤ºå‰20æ¡è®°å½•ï¼Œå…±${transactions.length}æ¡</p>` : ''}
            `;

            document.getElementById('transactionsTable').innerHTML = tableHtml;
        }

        // æ˜¾ç¤ºæŒä»“è¯¦æƒ…
        function displayHoldings(holdings) {
            if (!holdings || holdings.length === 0) {
                document.getElementById('holdingsTable').innerHTML = '<p>æš‚æ— æŒä»“è®°å½•</p>';
                return;
            }

            // è·å–æœ€æ–°çš„æŒä»“è®°å½•
            const latestHoldings = getLatestHoldings(holdings);

            const tableHtml = `
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th>æ ‡çš„</th>
                            <th>æŒä»“æ•°é‡</th>
                            <th>å¹³å‡æˆæœ¬</th>
                            <th>å¸‚å€¼</th>
                            <th>æœªå®ç°ç›ˆäº</th>
                            <th>æƒé‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${latestHoldings.map(holding => `
                            <tr>
                                <td>${holding.instrument?.symbol || 'N/A'}</td>
                                <td>${parseFloat(holding.quantity).toFixed(3)}</td>
                                <td>$${parseFloat(holding.average_cost).toFixed(2)}</td>
                                <td>$${parseFloat(holding.market_value).toFixed(2)}</td>
                                <td style="color: ${holding.unrealized_pnl >= 0 ? '#48bb78' : '#f56565'}">
                                    $${parseFloat(holding.unrealized_pnl || 0).toFixed(2)}
                                </td>
                                <td>${(parseFloat(holding.weight || 0) * 100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('holdingsTable').innerHTML = tableHtml;
        }

        // è·å–æœ€æ–°æŒä»“è®°å½•
        function getLatestHoldings(holdings) {
            const latestDate = Math.max(...holdings.map(h => new Date(h.holding_date).getTime()));
            return holdings.filter(h => new Date(h.holding_date).getTime() === latestDate);
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>